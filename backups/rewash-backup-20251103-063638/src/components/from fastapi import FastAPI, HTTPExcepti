from fastapi import FastAPI, HTTPException, Depends, Request
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional
import os

# Import services
from services.ai_chat import ChatService
from services.calendar import CalendarService
from services.email import EmailService
from services.docs_reader import DocsReaderService
from services.voice import VoiceService

app = FastAPI(title="Personal Assistant AI API")

# Configure CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Frontend URL
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Dependency Injection
def get_chat_service():
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        raise HTTPException(status_code=500, detail="API key not configured")
    return ChatService(api_key)

# Models
class ChatMessage(BaseModel):
    role: str
    content: str

class ChatRequest(BaseModel):
    messages: List[ChatMessage]
    context: Optional[str] = None

class ChatResponse(BaseModel):
    message: ChatMessage
    suggested_actions: Optional[List[str]] = None

# Routes
@app.get("/")
def read_root():
    return {"status": "online", "service": "Personal Assistant AI"}

@app.post("/chat", response_model=ChatResponse)
async def chat_endpoint(request: ChatRequest, chat_service: ChatService = Depends(get_chat_service)):
    try:
        response = await chat_service.get_response(
            messages=request.messages,
            context=request.context
        )
        return response
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)